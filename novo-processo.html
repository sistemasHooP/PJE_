<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Novo Processo - Sistema Jurídico</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Flatpickr para DatePicker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

    <!-- CSS do Projeto -->
    <link rel="stylesheet" href="./css/style.css">

    <style>
        /* Pequenas animações locais (caso seu CSS global não tenha) */
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-down { animation: slideDown .22s ease-out both; }

        .input-focus:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(59,130,246,.15);
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">

<!-- Layout -->
<div class="flex min-h-screen">

    <!-- Sidebar -->
    <aside class="w-72 bg-slate-900 text-white hidden md:flex flex-col">
        <div class="p-6 border-b border-white/10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 3l10 6-10 6-10-6 10-6z"></path>
                        <path d="M2 9v6l10 6 10-6V9"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold">RPPS</h1>
                    <p class="text-xs text-slate-300">Jurídico v1.0</p>
                </div>
            </div>
        </div>

        <div class="p-6 border-b border-white/10">
            <div class="flex items-center gap-3">
                <div id="user-avatar" class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center font-bold">
                    A
                </div>
                <div>
                    <div id="user-name-display" class="font-semibold">Usuário</div>
                    <div id="user-profile-display" class="text-xs text-slate-300">Perfil</div>
                </div>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-2">
            <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M3 3h7v7H3V3zM14 3h7v7h-7V3zM14 14h7v7h-7v-7zM3 14h7v7H3v-7z"></path>
                </svg>
                Dashboard
            </a>
            <a href="processos.html" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M7 7h10M7 11h10M7 15h10M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path>
                </svg>
                Processos
            </a>
            <a href="clientes.html" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <path d="M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"></path>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                Clientes
            </a>
            <a href="novo-processo.html" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-600 shadow-lg shadow-blue-600/25 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M12 5v14M5 12h14"></path>
                </svg>
                Novo Processo
            </a>
        </nav>

        <div class="p-4">
            <button id="desktop-logout-btn" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-white/10 hover:bg-white/15 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M10 17l5-5m0 0l-5-5m5 5H3"></path>
                    <path d="M21 12a9 9 0 0 0-9-9"></path>
                    <path d="M21 12a9 9 0 0 1-9 9"></path>
                </svg>
                Sair do Sistema
            </button>
        </div>
    </aside>

    <!-- Conteúdo -->
    <main class="flex-1 p-4 md:p-8">

        <!-- Header -->
        <div class="flex items-start justify-between gap-4 mb-6">
            <div>
                <h2 class="text-2xl font-bold text-slate-900">Novo Processo</h2>
                <p class="text-slate-500">Cadastre um novo processo no sistema</p>
            </div>
            <a href="processos.html" class="inline-flex items-center gap-2 text-slate-600 hover:text-blue-600 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M15 18l-6-6 6-6"></path>
                </svg>
                Voltar para lista
            </a>
        </div>

        <!-- Stepper -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-6">
            <div class="flex items-center justify-center gap-4">
                <div class="flex items-center gap-3">
                    <div id="step-1-circle" class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">1</div>
                    <div class="font-semibold text-slate-800">Cliente</div>
                </div>
                <div class="w-16 h-1 rounded-full bg-slate-200"></div>
                <div class="flex items-center gap-3">
                    <div id="step-2-circle" class="w-10 h-10 rounded-full bg-slate-200 text-slate-700 flex items-center justify-center font-bold">2</div>
                    <div class="font-semibold text-slate-400">Processo</div>
                </div>
            </div>
        </div>

        <!-- Conteúdo Etapa 1 -->
        <div id="step1-content" class="animate-fadeIn">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-6">

                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <path d="M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-900">Identificar Cliente</h3>
                        <p class="text-slate-500 text-sm">Busque pelo nome, CPF ou email — ou cadastre um novo cliente</p>
                    </div>
                </div>

                <!-- Busca ÚNICA (nome/email/CPF) -->
                <div class="mb-6 p-4 bg-slate-50 border border-slate-200 rounded-xl">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Buscar Cliente (nome, CPF ou email)</label>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative flex-1">
                            <input
                                type="text"
                                id="cliente-busca-rapida"
                                list="clientes-lista"
                                placeholder="Digite nome, CPF (11 dígitos) ou email"
                                class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:outline-none focus:border-blue-500 input-focus transition-all"
                                autocomplete="off"
                            >
                            <datalist id="clientes-lista"></datalist>

                            <div id="clientes-sugestoes"
                                 class="hidden absolute z-10 mt-2 w-full bg-white border border-slate-200 rounded-lg shadow-xl max-h-72 overflow-y-auto">
                            </div>
                        </div>

                        <button
                            id="btn-usar-cliente-rapido"
                            type="button"
                            class="px-5 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl shadow-lg shadow-emerald-500/30 transition-all"
                        >
                            Usar Cliente
                        </button>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">
                        Dica: digite nome, email ou CPF. Se for CPF completo (11 dígitos), pressione Enter para buscar no servidor.
                        Se não existir, você pode cadastrar aqui mesmo.
                    </p>
                </div>

                <!-- Resultado da Busca: Cliente Encontrado -->
                <div id="cliente-encontrado" class="hidden animate-slide-down">
                    <div class="bg-emerald-50 border-2 border-emerald-200 rounded-xl p-5 mb-6">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-xl bg-emerald-100 flex items-center justify-center font-bold text-emerald-700" id="cliente-iniciais">C</div>
                                <div>
                                    <h4 class="font-bold text-emerald-900 text-lg" id="cliente-nome">Cliente</h4>
                                    <div class="text-sm text-emerald-900/80 mt-1" id="cliente-email">email@exemplo.com</div>
                                    <div class="text-sm text-emerald-900/70 mt-1" id="cliente-cpf-display">CPF: ---</div>
                                </div>
                            </div>
                            <button id="btn-limpar-cliente" type="button" class="px-4 py-2 rounded-xl bg-white border border-emerald-200 text-emerald-700 font-semibold hover:bg-emerald-100 transition">
                                Trocar
                            </button>
                        </div>
                    </div>

                    <input type="hidden" id="cliente-id-selecionado" value="">

                    <div class="flex items-center justify-end gap-3">
                        <button id="btn-avancar" type="button" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-all">
                            Continuar
                        </button>
                    </div>
                </div>

                <!-- Resultado da Busca: Cliente Não Encontrado -->
                <div id="cliente-nao-encontrado" class="hidden animate-slide-down">
                    <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-5 mb-6">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                    <path d="M12 9v4"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-amber-800">Cliente não encontrado</h4>
                                <p class="text-sm text-amber-800/80">Não localizei este cliente. Você pode cadastrar abaixo.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Formulário Novo Cliente -->
                    <div class="space-y-4">
                        <h4 class="font-semibold text-slate-700 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 0 1 8 0z"></path>
                                <path d="M6 21v-2a4 4 0 0 1 4-4h4"></path>
                            </svg>
                            Cadastrar Novo Cliente
                        </h4>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Nome Completo</label>
                                <input id="novo-cliente-nome" type="text" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:outline-none focus:border-blue-500 input-focus transition-all" placeholder="Nome do cliente" />
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">CPF</label>
                                <input id="novo-cliente-cpf" type="text" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:outline-none focus:border-blue-500 input-focus transition-all" placeholder="000.000.000-00" />
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Telefone</label>
                                <input id="novo-cliente-telefone" type="text" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:outline-none focus:border-blue-500 input-focus transition-all" placeholder="(00) 00000-0000" />
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Email</label>
                                <input id="novo-cliente-email" type="email" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:outline-none focus:border-blue-500 input-focus transition-all" placeholder="email@exemplo.com" />
                            </div>
                        </div>

                        <div class="flex items-center justify-end gap-3">
                            <button id="btn-cancelar-novo-cliente" type="button" class="px-6 py-3 rounded-xl bg-white border border-slate-200 text-slate-700 font-semibold hover:bg-slate-50 transition-all">
                                Cancelar
                            </button>
                            <button id="btn-cadastrar-novo-cliente" type="button" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-all">
                                Cadastrar e Continuar
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Conteúdo Etapa 2 -->
        <div id="step2-content" class="hidden animate-fadeIn">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M9 12h6"></path>
                            <path d="M9 16h6"></path>
                            <path d="M7 20h10a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H9l-2 2H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-900">Dados do Processo</h3>
                        <p class="text-slate-500 text-sm">Preencha as informações do processo</p>
                    </div>
                </div>

                <form id="form-processo" class="space-y-5">
                    <input type="hidden" id="cliente-id" value="">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Número do Processo</label>
                            <input id="numero-processo" type="text" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:outline-none focus:border-blue-500 input-focus transition-all" placeholder="0000000-00.0000.0.00.0000" required>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Título / Assunto</label>
                            <input id="titulo-processo" type="text" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:outline-none focus:border-blue-500 input-focus transition-all" placeholder="Ex: Aposentadoria / Revisão / etc" required>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Órgão</label>
                            <input id="orgao-processo" type="text" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:outline-none focus:border-blue-500 input-focus transition-all" placeholder="Ex: TJRN / TRF / etc" required>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Data de Ajuizamento</label>
                            <input id="data-ajuizamento" type="text" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:outline-none focus:border-blue-500 input-focus transition-all" placeholder="dd/mm/aaaa" required>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Observações</label>
                            <textarea id="observacoes" rows="4" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:outline-none focus:border-blue-500 input-focus transition-all" placeholder="Observações iniciais (opcional)"></textarea>
                        </div>
                    </div>

                    <div class="flex items-center justify-between gap-3 pt-2">
                        <button id="btn-voltar" type="button" class="px-6 py-3 rounded-xl bg-white border border-slate-200 text-slate-700 font-semibold hover:bg-slate-50 transition-all">
                            Voltar
                        </button>
                        <button id="btn-salvar" type="submit" class="px-6 py-3 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700 transition-all">
                            Salvar Processo
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </main>
</div>

<!-- JS do Projeto -->
<script src="./js/config.js"></script>
<script src="./js/utils.js"></script>
<script src="./js/api.js"></script>
<script src="./js/auth.js"></script>

<script>
    // =========================================================================
    // ESTADO
    // =========================================================================
    let clienteSelecionado = null;

    // cache local (lista de clientes para sugestões)
    let listaClientesCache = [];
    let clientesById = {};

    // A chave do cache segue o padrão do API.fetchWithCache: action + '_' + JSON.stringify(params)
    const CLIENTES_CACHE_KEY = `listarClientes_${JSON.stringify({})}`;

    // Sincronização entre abas
    const SYNC_KEY = 'rpps_clientes_last_update';
    const SYNC_CHANNEL = 'rpps_juridico_sync';
    let bc = null;

    // =========================================================================
    // HELPERS
    // =========================================================================
    function normalizarCPFFrontend(valor) {
        const digits = String(valor || '').replace(/\D/g, '');
        if (!digits) return '';
        return digits.substring(0, 11).padStart(11, '0');
    }

    function normalizarTelefoneFrontend(valor) {
        const digits = String(valor || '').replace(/\D/g, '');
        return digits.substring(0, 11);
    }

    function formatarCPFParaExibicao(cpf) {
        const bruto = String(cpf || '').trim();
        const digitos = bruto.replace(/\D/g, '');
        if (digitos.length === 11) {
            return digitos.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
        // Quando vier mascarado da API (***.***.***-**) preserva visual
        return bruto || '-';
    }

    // Escapa HTML para evitar injeção ao renderizar sugestões
    function escapeHtml(text) {
        return String(text || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function rebuildClientesIndex() {
        clientesById = {};
        (listaClientesCache || []).forEach(function(c) {
            if (c && c.id != null) {
                clientesById[String(c.id)] = c;
            }
        });
    }

    function upsertClienteNaSelecaoRapida(cliente) {
        if (!cliente || !cliente.id) return;

        const id = String(cliente.id);
        const idx = (listaClientesCache || []).findIndex(function(c) { return String(c.id) === id; });

        if (idx >= 0) {
            listaClientesCache[idx] = Object.assign({}, listaClientesCache[idx], cliente);
        } else {
            listaClientesCache.push(cliente);
        }

        // Ordena por nome
        listaClientesCache.sort(function(a, b) {
            const an = String(a.nome_completo || '').toLowerCase();
            const bn = String(b.nome_completo || '').toLowerCase();
            return an.localeCompare(bn);
        });

        rebuildClientesIndex();

        // Atualiza cache local (para ajudar outras abas)
        try {
            Utils.Cache.set(CLIENTES_CACHE_KEY, listaClientesCache, 60);
        } catch (e) {}

        // Atualiza datalist
        preencherDatalistClientes();
    }

    function preencherDatalistClientes() {
        const dl = document.getElementById('clientes-lista');
        if (!dl) return;

        dl.innerHTML = (listaClientesCache || []).slice(0, 200).map(function(c) {
            const label = `${c.nome_completo || '-'} | ${formatarCPFParaExibicao(c.cpf || '-') } | ${c.email || '-'}`;
            return `<option value="${escapeHtml(label)}"></option>`;
        }).join('');
    }

    // =========================================================================
    // INICIALIZAÇÃO
    // =========================================================================
    document.addEventListener('DOMContentLoaded', function() {
        // Proteção de rota
        if (!Auth.protectRoute()) return;

        // UI do usuário
        Auth.updateUserInfoUI();

        // Flatpickr
        if (window.flatpickr) {
            flatpickr("#data-ajuizamento", {
                locale: "pt",
                dateFormat: "d/m/Y",
                allowInput: true
            });
        }

        // Eventos principais
        const logout = document.getElementById('desktop-logout-btn');
        if (logout) {
            logout.addEventListener('click', function() {
                if (confirm('Sair do sistema?')) Auth.logout();
            });
        }

        const btnUsarRapido = document.getElementById('btn-usar-cliente-rapido');
        if (btnUsarRapido) btnUsarRapido.addEventListener('click', selecionarClienteRapido);

        const btnAvancar = document.getElementById('btn-avancar');
        if (btnAvancar) btnAvancar.addEventListener('click', avancarParaProcesso);

        const btnVoltar = document.getElementById('btn-voltar');
        if (btnVoltar) btnVoltar.addEventListener('click', voltarParaCliente);

        const btnLimpar = document.getElementById('btn-limpar-cliente');
        if (btnLimpar) btnLimpar.addEventListener('click', limparCliente);

        const btnCancelarNovo = document.getElementById('btn-cancelar-novo-cliente');
        if (btnCancelarNovo) btnCancelarNovo.addEventListener('click', limparFormNovoCliente);

        const btnCadastrarNovo = document.getElementById('btn-cadastrar-novo-cliente');
        if (btnCadastrarNovo) btnCadastrarNovo.addEventListener('click', cadastrarEAvancar);

        const formProc = document.getElementById('form-processo');
        if (formProc) formProc.addEventListener('submit', salvarProcesso);

        // Máscaras do form novo cliente
        const cpfNovo = document.getElementById('novo-cliente-cpf');
        if (cpfNovo) {
            cpfNovo.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.substring(0, 11);
                if (value.length > 9) value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
                else if (value.length > 6) value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
                else if (value.length > 3) value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
                e.target.value = value;
            });
        }

        const telNovo = document.getElementById('novo-cliente-telefone');
        if (telNovo) {
            telNovo.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '').substring(0, 11);
                if (value.length > 6) value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
                else if (value.length > 2) value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
                e.target.value = value;
            });
        }

        // Busca: eventos do input único
        const inputRapido = document.getElementById('cliente-busca-rapida');
        if (inputRapido) {
            inputRapido.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    selecionarClienteRapido();
                }
            });
            inputRapido.addEventListener('input', renderSugestoesClientes);
            inputRapido.addEventListener('focus', renderSugestoesClientes);
        }

        document.addEventListener('click', function(e) {
            const box = document.getElementById('clientes-sugestoes');
            const input = document.getElementById('cliente-busca-rapida');
            if (!box || !input) return;
            const wrap = input.parentElement;
            if (wrap && !wrap.contains(e.target)) box.classList.add('hidden');
        });

        // Sincronização + carga
        initClientesSync();
        carregarClientesRapido();
    });

    // =========================================================================
    // SINCRONIZAÇÃO CLIENTES (entre abas)
    // =========================================================================
    function initClientesSync() {
        // BroadcastChannel
        try {
            if ('BroadcastChannel' in window) {
                bc = new BroadcastChannel(SYNC_CHANNEL);
                bc.onmessage = function(ev) {
                    const msg = ev && ev.data ? ev.data : null;
                    if (msg && msg.type === 'clientes_updated') {
                        hidratarCacheClientes();
                        carregarClientesRapido(true);
                    }
                };
            }
        } catch(e) {}

        // Storage event
        window.addEventListener('storage', function(e) {
            if (e.key === SYNC_KEY) {
                hidratarCacheClientes();
                carregarClientesRapido(true);
            }
        });

        // Hidrata no load
        hidratarCacheClientes();
    }

    function broadcastClientesAtualizados() {
        try { localStorage.setItem(SYNC_KEY, String(Date.now())); } catch(e) {}
        try { if (bc) bc.postMessage({ type: 'clientes_updated', ts: Date.now() }); } catch(e) {}
    }

    function hidratarCacheClientes() {
        try {
            const cached = Utils.Cache.get(CLIENTES_CACHE_KEY);
            if (Array.isArray(cached) && cached.length) {
                listaClientesCache = cached;
                rebuildClientesIndex();
                preencherDatalistClientes();
            }
        } catch(e) {}
    }

    // =========================================================================
    // CARREGAR CLIENTES RÁPIDO (SWR)
    // =========================================================================
    function carregarClientesRapido(forceSilent) {
        API.clientes.listar(function(lista, source) {
            const data = Array.isArray(lista) ? lista : [];
            listaClientesCache = data;
            rebuildClientesIndex();
            preencherDatalistClientes();

            // atualiza cache com TTL maior (clientes)
            try { Utils.Cache.set(CLIENTES_CACHE_KEY, data, 60); } catch(e) {}

            if (source === 'network') {
                broadcastClientesAtualizados();
            }
        }, !!forceSilent);
    }

    // =========================================================================
    // BUSCA/SELEÇÃO ÚNICA (nome/email/cpf)
    // =========================================================================
    function filtrarClientesRapido(termo) {
        const t = String(termo || '').toLowerCase().trim();
        const tCpf = t.replace(/\D/g, '');
        if (!t) return listaClientesCache.slice(0, 8);

        // tokens (para busca mais inteligente por nome)
        const tokens = t.split(/\s+/).filter(Boolean);

        return (listaClientesCache || []).filter(function(c) {
            const nome = String(c.nome_completo || '').toLowerCase();
            const email = String(c.email || '').toLowerCase();
            const cpfMask = String(c.cpf || '').toLowerCase();
            const cpfDigits = cpfMask.replace(/\D/g, '');

            // match por tokens no nome
            const nomeOk = tokens.length ? tokens.every(function(tok) { return nome.includes(tok); }) : false;

            return (
                nomeOk ||
                nome.includes(t) ||
                email.includes(t) ||
                cpfMask.includes(t) ||
                (tCpf && cpfDigits.includes(tCpf))
            );
        }).slice(0, 8);
    }

    function renderSugestoesClientes() {
        const box = document.getElementById('clientes-sugestoes');
        const input = document.getElementById('cliente-busca-rapida');
        if (!box || !input) return;

        const termo = input.value || '';
        const itens = filtrarClientesRapido(termo);

        if (!itens.length) {
            const digits11 = String(termo || '').replace(/\D/g, '');
            let extra = '';
            if (digits11.length === 11) {
                extra = `
                    <div class="px-3 pb-3">
                        <button id="btn-buscar-cpf-servidor" type="button"
                            class="w-full px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-all">
                            Buscar CPF no servidor
                        </button>
                    </div>
                `;
            }

            box.innerHTML = `
                <div class="px-3 py-3 text-sm text-slate-500">
                    Nenhum cliente encontrado no cache.
                    <div class="text-xs text-slate-400 mt-1">
                        Dica: digite nome, email, ou CPF completo.
                    </div>
                </div>
                ${extra}
            `;
            box.classList.remove('hidden');

            const btnSrv = document.getElementById('btn-buscar-cpf-servidor');
            if (btnSrv) {
                btnSrv.addEventListener('click', function() {
                    selecionarClienteRapido();
                });
            }
            return;
        }

        box.innerHTML = itens.map(function(c) {
            const nome = escapeHtml(c.nome_completo || '-');
            const email = escapeHtml(c.email || '-');
            const cpf = escapeHtml(formatarCPFParaExibicao(c.cpf || '-'));
            const id = escapeHtml(String(c.id || ''));
            const iniciais = escapeHtml(((c.nome_completo || 'C').trim().charAt(0) || 'C').toUpperCase());
            const valor = escapeHtml((c.nome_completo || '') + ' | ' + (formatarCPFParaExibicao(c.cpf) || '') + ' | ' + (c.email || ''));

            return `
                <button type="button"
                    class="w-full text-left px-3 py-3 hover:bg-slate-50 transition-all border-b border-slate-100 last:border-b-0"
                    data-id="${id}"
                    data-valor="${valor}">
                    <div class="flex items-start gap-3">
                        <div class="w-9 h-9 rounded-lg bg-slate-200 text-slate-700 flex items-center justify-center font-bold flex-shrink-0">
                            ${iniciais}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-slate-800 truncate">${nome}</div>
                            <div class="text-xs text-slate-500 mt-0.5 truncate">${email}</div>
                            <div class="text-xs text-slate-400 mt-1">CPF: ${cpf}</div>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="text-xs px-2 py-1 rounded-lg bg-emerald-50 text-emerald-700 font-semibold">
                                Selecionar
                            </span>
                        </div>
                    </div>
                </button>
            `;
        }).join('');

        box.classList.remove('hidden');

        box.querySelectorAll('[data-id]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const val = this.getAttribute('data-valor') || '';
                input.value = val;
                box.classList.add('hidden');
                selecionarClienteRapido(id);
            });
        });
    }

    async function selecionarClienteRapido(clienteIdForcado) {
        const input = document.getElementById('cliente-busca-rapida');
        const termoBruto = String(input ? input.value : '').trim();
        const termo = termoBruto.toLowerCase();

        const btnUsar = document.getElementById('btn-usar-cliente-rapido');
        if (btnUsar) {
            btnUsar.classList.add('btn-loading');
            btnUsar.disabled = true;
        }

        try {
            if (!termoBruto && !clienteIdForcado) {
                Utils.showToast('Digite um cliente para selecionar.', 'warning');
                if (input) input.focus();
                return;
            }

            let cliente = null;

            // 1) Se veio por clique de sugestão: usa ID direto
            if (clienteIdForcado) {
                cliente = clientesById[String(clienteIdForcado)] || null;
            }

            // 2) Tentativas: ID, CPF, Email, Nome (no cache)
            if (!cliente && termoBruto) {

                // ID direto
                if (/^\d+$/.test(termoBruto)) {
                    cliente = clientesById[String(termoBruto)] || null;
                }

                // CPF (digits) - OBS: no cache é mascarado, então pode não achar CPF completo
                if (!cliente) {
                    const digits = termoBruto.replace(/\D/g, '');
                    if (digits.length >= 6) {
                        const candidatosCpf = (listaClientesCache || []).filter(function(c) {
                            const cCpf = String(c.cpf || '').replace(/\D/g, '');
                            return cCpf && cCpf.includes(digits);
                        });

                        if (candidatosCpf.length === 1) cliente = candidatosCpf[0];
                        else if (candidatosCpf.length > 1) {
                            Utils.showToast('Encontrei mais de 1 cliente com esse CPF. Refine a busca.', 'warning');
                            renderSugestoesClientes();
                            return;
                        }
                    }
                }

                // Email exato
                if (!cliente && termo.includes('@')) {
                    const byEmail = (listaClientesCache || []).filter(function(c) {
                        return String(c.email || '').toLowerCase() === termo;
                    });
                    if (byEmail.length === 1) cliente = byEmail[0];
                }

                // Nome - se bater exato
                if (!cliente) {
                    const byNome = (listaClientesCache || []).filter(function(c) {
                        return String(c.nome_completo || '').toLowerCase() === termo;
                    });
                    if (byNome.length === 1) cliente = byNome[0];
                }

                // Se ainda não achou, tenta o primeiro da lista filtrada
                if (!cliente) {
                    const top = filtrarClientesRapido(termoBruto);
                    if (top.length === 1) cliente = top[0];
                }
            }

            if (!cliente) {
                // Se digitou CPF completo (11 dígitos), busca no servidor
                const digits11 = String(termoBruto || '').replace(/\D/g, '');
                if (!clienteIdForcado && digits11.length === 11) {
                    try {
                        const encontrado = await API.call('buscarClientePorCPF', { cpf: digits11 }, 'POST', true);
                        if (encontrado && encontrado.id) {
                            upsertClienteNaSelecaoRapida(encontrado);

                            if (input) {
                                input.value = (encontrado.nome_completo || '-') + ' | ' + formatarCPFParaExibicao(encontrado.cpf) + ' | ' + (encontrado.email || '-');
                            }

                            const sugSrv = document.getElementById('clientes-sugestoes');
                            if (sugSrv) sugSrv.classList.add('hidden');

                            mostrarClienteEncontrado(encontrado);

                            // Busca completo em background
                            API.clientes.buscarPorId(encontrado.id)
                                .then(function(completo) {
                                    if (completo && completo.id) {
                                        upsertClienteNaSelecaoRapida(completo);
                                        if (clienteSelecionado && String(clienteSelecionado.id) === String(completo.id)) {
                                            mostrarClienteEncontrado(completo);
                                        }
                                    }
                                })
                                .catch(function() {});

                            return;
                        }
                    } catch (err) {
                        const msg = (err && err.message) ? err.message : '';
                        if (msg.toLowerCase().includes('não encontrado') || msg.toLowerCase().includes('nao encontrado')) {
                            mostrarFormNovoCliente(digits11);
                            Utils.showToast('Cliente não encontrado. Você pode cadastrar abaixo.', 'warning');
                            return;
                        }
                        Utils.showToast(msg || 'Falha ao buscar cliente no servidor.', 'error');
                        return;
                    }
                }

                Utils.showToast('Cliente não encontrado. Digite nome, email ou CPF completo (11 dígitos).', 'warning');
                renderSugestoesClientes();
                return;
            }

            // Esconde sugestões ao selecionar
            const sug = document.getElementById('clientes-sugestoes');
            if (sug) sug.classList.add('hidden');

            // Mostra IMEDIATO
            mostrarClienteEncontrado(cliente);

            // Busca dados completos em BACKGROUND (não trava)
            if (cliente.id) {
                API.clientes.buscarPorId(cliente.id)
                    .then(function(completo) {
                        if (completo && completo.id) {
                            upsertClienteNaSelecaoRapida(completo);

                            if (clienteSelecionado && String(clienteSelecionado.id) === String(completo.id)) {
                                mostrarClienteEncontrado(completo);
                            }
                        }
                    })
                    .catch(function() {});
            }

        } finally {
            if (btnUsar) {
                btnUsar.classList.remove('btn-loading');
                btnUsar.disabled = false;
            }
        }
    }

    // Compatibilidade: se em algum ponto você ainda chamar buscarCliente()
    async function buscarCliente() {
        const cpfInput = document.getElementById('cpf-busca') || document.getElementById('cliente-busca-rapida');
        if (!cpfInput) return;
        const cpf = normalizarCPFFrontend(cpfInput.value);

        if (cpf.length !== 11) {
            Utils.showToast('Digite um CPF válido com 11 dígitos.', 'warning');
            cpfInput.focus();
            return;
        }

        const btn = document.getElementById('btn-buscar-cpf') || document.getElementById('btn-usar-cliente-rapido');
        if (btn) {
            btn.classList.add('btn-loading');
            btn.disabled = true;
        }

        try {
            const cliente = await API.call('buscarClientePorCPF', { cpf: cpf }, 'POST', true);
            if (cliente && cliente.id) {
                upsertClienteNaSelecaoRapida(cliente);
                mostrarClienteEncontrado(cliente);
            }
        } catch (error) {
            mostrarFormNovoCliente(cpf);
            Utils.showToast('Cliente não encontrado. Você pode cadastrar abaixo.', 'warning');
        } finally {
            if (btn) {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }
    }

    // =========================================================================
    // EXIBIÇÃO DE RESULTADOS
    // =========================================================================
    function mostrarClienteEncontrado(cliente) {
        clienteSelecionado = cliente;

        const cpfDisplay = formatarCPFParaExibicao(cliente.cpf);

        const iniciais = (cliente.nome_completo ? cliente.nome_completo.charAt(0).toUpperCase() : 'C');
        const elIniciais = document.getElementById('cliente-iniciais');
        const elNome = document.getElementById('cliente-nome');
        const elEmail = document.getElementById('cliente-email');
        const elCpf = document.getElementById('cliente-cpf-display');
        const elHidden = document.getElementById('cliente-id-selecionado');

        if (elIniciais) elIniciais.textContent = iniciais;
        if (elNome) elNome.textContent = cliente.nome_completo || 'Cliente';
        if (elEmail) elEmail.textContent = cliente.email || '-';
        if (elCpf) elCpf.textContent = 'CPF: ' + (cpfDisplay || '-');
        if (elHidden) elHidden.value = cliente.id || '';

        const boxOk = document.getElementById('cliente-encontrado');
        const boxNo = document.getElementById('cliente-nao-encontrado');
        if (boxOk) boxOk.classList.remove('hidden');
        if (boxNo) boxNo.classList.add('hidden');

        Utils.showToast('Cliente selecionado!', 'success');
    }

    function mostrarFormNovoCliente(cpf) {
        const cpfFormatado = formatarCPFParaExibicao(cpf);

        const boxOk = document.getElementById('cliente-encontrado');
        const boxNo = document.getElementById('cliente-nao-encontrado');
        if (boxOk) boxOk.classList.add('hidden');
        if (boxNo) boxNo.classList.remove('hidden');

        const cpfEl = document.getElementById('novo-cliente-cpf');
        if (cpfEl) cpfEl.value = cpfFormatado;

        const nomeEl = document.getElementById('novo-cliente-nome');
        if (nomeEl) nomeEl.focus();
    }

    // =========================================================================
    // AÇÕES UI
    // =========================================================================
    function limparCliente() {
        clienteSelecionado = null;
        const boxOk = document.getElementById('cliente-encontrado');
        const boxNo = document.getElementById('cliente-nao-encontrado');
        if (boxOk) boxOk.classList.add('hidden');
        if (boxNo) boxNo.classList.add('hidden');

        const input = document.getElementById('cliente-busca-rapida');
        if (input) {
            input.value = '';
            input.focus();
        }
    }

    function limparFormNovoCliente() {
        const boxNo = document.getElementById('cliente-nao-encontrado');
        if (boxNo) boxNo.classList.add('hidden');

        const ids = ['novo-cliente-nome', 'novo-cliente-cpf', 'novo-cliente-email', 'novo-cliente-telefone'];
        ids.forEach(function(id) {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
    }

    async function cadastrarEAvancar() {
        const btn = document.getElementById('btn-cadastrar-novo-cliente');
        if (btn) {
            btn.classList.add('btn-loading');
            btn.disabled = true;
        }

        try {
            const nome = String(document.getElementById('novo-cliente-nome').value || '').trim();
            const cpf = normalizarCPFFrontend(document.getElementById('novo-cliente-cpf').value);
            const email = String(document.getElementById('novo-cliente-email').value || '').trim().toLowerCase();
            const telefone = normalizarTelefoneFrontend(document.getElementById('novo-cliente-telefone').value);

            if (!nome) throw new Error('Informe o nome do cliente.');
            if (!cpf || cpf.length !== 11) throw new Error('CPF inválido.');
            if (!email) throw new Error('Informe o e-mail do cliente.');

            const resultado = await API.call('cadastrarCliente', {
                nome_completo: nome,
                cpf: cpf,
                email: email,
                telefone: telefone
            });

            clienteSelecionado = resultado;
            upsertClienteNaSelecaoRapida(resultado);
            Utils.showToast('Cliente cadastrado com sucesso!', 'success');

            // Avança para o passo 2
            setTimeout(() => {
                avancarParaProcesso();
            }, 500);

        } catch (error) {
            console.error('Erro ao cadastrar cliente:', error);
            Utils.showToast(error.message || 'Erro ao cadastrar cliente.', 'error');
        } finally {
            if (btn) {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }
    }

    function avancarParaProcesso() {
        if (!clienteSelecionado || !clienteSelecionado.id) {
            Utils.showToast('Selecione um cliente para continuar.', 'warning');
            return;
        }

        document.getElementById('cliente-id').value = clienteSelecionado.id;

        document.getElementById('step1-content').classList.add('hidden');
        document.getElementById('step2-content').classList.remove('hidden');

        document.getElementById('step-1-circle').classList.remove('bg-blue-600', 'text-white');
        document.getElementById('step-1-circle').classList.add('bg-slate-200', 'text-slate-700');

        document.getElementById('step-2-circle').classList.remove('bg-slate-200', 'text-slate-700');
        document.getElementById('step-2-circle').classList.add('bg-blue-600', 'text-white');
    }

    function voltarParaCliente() {
        document.getElementById('step2-content').classList.add('hidden');
        document.getElementById('step1-content').classList.remove('hidden');

        document.getElementById('step-2-circle').classList.remove('bg-blue-600', 'text-white');
        document.getElementById('step-2-circle').classList.add('bg-slate-200', 'text-slate-700');

        document.getElementById('step-1-circle').classList.remove('bg-slate-200', 'text-slate-700');
        document.getElementById('step-1-circle').classList.add('bg-blue-600', 'text-white');
    }

    // =========================================================================
    // SALVAR PROCESSO
    // =========================================================================
    async function salvarProcesso(e) {
        e.preventDefault();

        const btn = document.getElementById('btn-salvar');
        if (btn) {
            btn.classList.add('btn-loading');
            btn.disabled = true;
        }

        try {
            const clienteId = document.getElementById('cliente-id').value;

            const payload = {
                cliente_id: clienteId,
                numero_processo: String(document.getElementById('numero-processo').value || '').trim(),
                titulo: String(document.getElementById('titulo-processo').value || '').trim(),
                orgao: String(document.getElementById('orgao-processo').value || '').trim(),
                data_ajuizamento: String(document.getElementById('data-ajuizamento').value || '').trim(),
                observacoes: String(document.getElementById('observacoes').value || '').trim()
            };

            if (!payload.numero_processo) throw new Error('Informe o número do processo.');
            if (!payload.titulo) throw new Error('Informe o título/assunto.');
            if (!payload.orgao) throw new Error('Informe o órgão.');
            if (!payload.data_ajuizamento) throw new Error('Informe a data de ajuizamento.');

            await API.call('criarProcesso', payload);

            Utils.showToast('Processo cadastrado com sucesso!', 'success');

            setTimeout(() => {
                window.location.href = 'processos.html';
            }, 900);

        } catch (error) {
            console.error('Erro ao salvar processo:', error);
            Utils.showToast(error.message || 'Erro ao salvar processo.', 'error');
        } finally {
            if (btn) {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }
    }
</script>

</body>
</html>
